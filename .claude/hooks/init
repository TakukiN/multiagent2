#!/bin/bash
# ClaudeåˆæœŸåŒ–ãƒ•ãƒƒã‚¯
# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã®è‡ªå‹•è¨­å®š

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
HOOKS_DIR="$PROJECT_ROOT/.claude/hooks"
LOG_FILE="$PROJECT_ROOT/docs/logs/claude_init.log"

# ãƒ­ã‚°é–¢æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INIT] $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "\033[32mâœ… [INIT] $1\033[0m" | tee -a "$LOG_FILE"
}

log_info() {
    echo -e "\033[34mâ„¹ï¸ [INIT] $1\033[0m" | tee -a "$LOG_FILE"
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$(dirname "$LOG_FILE")"

log_info "ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹"

# ç¾åœ¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ¤œå‡º
detect_agent_role() {
    local current_dir=$(basename "$(pwd)")
    local agent_role=""
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‹ã‚‰ãƒ­ãƒ¼ãƒ«æ¤œå‡º
    case "$current_dir" in
        *code_analyst*)
            agent_role="code_analyst"
            ;;
        *test_designer*)
            agent_role="test_designer"
            ;;
        *test_writer*)
            agent_role="test_writer"
            ;;
        *tester*)
            agent_role="tester"
            ;;
        *architect*)
            agent_role="architect"
            ;;
        *refactorer*)
            agent_role="refactorer"
            ;;
        *code_reviewer*)
            agent_role="code_reviewer"
            ;;
        *refactor_pm*)
            agent_role="refactor_pm"
            ;;
        *)
            # .claude_agentãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¤œå‡º
            if [ -f ".claude_agent" ]; then
                agent_role=$(grep "AGENT_NAME=" .claude_agent | cut -d'=' -f2)
            fi
            ;;
    esac
    
    echo "$agent_role"
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒè¨­å®š
setup_agent_environment() {
    local agent_role="$1"
    
    if [ -z "$agent_role" ]; then
        log_info "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒç‰¹å®šã§ãã¾ã›ã‚“ã€‚æ±ç”¨è¨­å®šã‚’é©ç”¨ã—ã¾ã™"
        return
    fi
    
    log_info "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒè¨­å®š: $agent_role"
    
    # æŒ‡ç¤ºæ›¸ã®èª­ã¿è¾¼ã¿
    local instruction_file="$PROJECT_ROOT/instructions/${agent_role}.md"
    if [ -f "$instruction_file" ]; then
        log_success "æŒ‡ç¤ºæ›¸èª­ã¿è¾¼ã¿: $instruction_file"
        export CLAUDE_INSTRUCTION_FILE="$instruction_file"
        
        # Claudeèµ·å‹•æ™‚ã®è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š
        export CLAUDE_AUTO_MESSAGE="ã‚ãªãŸã¯${agent_role}ã§ã™ã€‚instructions/${agent_role}.mdã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚"
    else
        log_info "æŒ‡ç¤ºæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $instruction_file"
    fi
    
    # ãƒ­ãƒ¼ãƒ«å›ºæœ‰ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
    export CLAUDE_AGENT_ROLE="$agent_role"
    export CLAUDE_PROJECT_ROOT="$PROJECT_ROOT"
    export CLAUDE_LOG_DIR="$PROJECT_ROOT/docs/logs"
    
    # ãƒ­ãƒ¼ãƒ«åˆ¥ã®å°‚ç”¨è¨­å®š
    case "$agent_role" in
        "code_analyst")
            setup_code_analyst_env
            ;;
        "test_designer"|"test_writer"|"tester")
            setup_test_env
            ;;
        "architect")
            setup_architect_env
            ;;
        "refactorer")
            setup_refactorer_env
            ;;
        "code_reviewer")
            setup_reviewer_env
            ;;
        "refactor_pm")
            setup_pm_env
            ;;
    esac
}

# Code Analystç’°å¢ƒè¨­å®š
setup_code_analyst_env() {
    log_info "Code Analystå°‚ç”¨ç’°å¢ƒè¨­å®š"
    export CLAUDE_ANALYSIS_TARGET="src/"
    export CLAUDE_REPORT_DIR="$PROJECT_ROOT/docs/logs"
}

# Testé–¢é€£ç’°å¢ƒè¨­å®š
setup_test_env() {
    log_info "ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š"
    export CLAUDE_TEST_DIR="$PROJECT_ROOT/tests"
    export CLAUDE_TEST_RUNNER="./scripts/run_and_verify_tests.sh"
}

# Architectç’°å¢ƒè¨­å®š
setup_architect_env() {
    log_info "Architectå°‚ç”¨ç’°å¢ƒè¨­å®š"
    export CLAUDE_DESIGN_DIR="$PROJECT_ROOT/docs/design"
    export CLAUDE_SPEC_DIR="$PROJECT_ROOT/docs/specs"
}

# Refactorerç’°å¢ƒè¨­å®š
setup_refactorer_env() {
    log_info "Refactorerå°‚ç”¨ç’°å¢ƒè¨­å®š"
    export CLAUDE_BACKUP_DIR="$PROJECT_ROOT/.backups"
    export CLAUDE_TEST_BEFORE_REFACTOR="true"
    mkdir -p "$CLAUDE_BACKUP_DIR"
}

# Code Reviewerç’°å¢ƒè¨­å®š
setup_reviewer_env() {
    log_info "Code Reviewerå°‚ç”¨ç’°å¢ƒè¨­å®š"
    export CLAUDE_REVIEW_DIR="$PROJECT_ROOT/docs/logs"
    export CLAUDE_STATIC_ANALYSIS="true"
}

# Project Managerç’°å¢ƒè¨­å®š
setup_pm_env() {
    log_info "Project Managerå°‚ç”¨ç’°å¢ƒè¨­å®š"
    export CLAUDE_DASHBOARD_DIR="$PROJECT_ROOT/docs/logs"
    export CLAUDE_AGENT_COORDINATION="true"
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šèª­ã¿è¾¼ã¿
load_project_config() {
    log_info "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šèª­ã¿è¾¼ã¿"
    
    # CLAUDE.mdã®èª­ã¿è¾¼ã¿
    if [ -f "$PROJECT_ROOT/CLAUDE.md" ]; then
        log_success "CLAUDE.mdèª­ã¿è¾¼ã¿"
        export CLAUDE_PROJECT_CONFIG="$PROJECT_ROOT/CLAUDE.md"
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰è¨­å®š
    if [ -f "$PROJECT_ROOT/.claude/settings.local.json" ]; then
        log_success "ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šèª­ã¿è¾¼ã¿"
        export CLAUDE_LOCAL_SETTINGS="$PROJECT_ROOT/.claude/settings.local.json"
    fi
    
    # ä»•æ§˜æ›¸ã®ç¢ºèª
    if [ -f "$PROJECT_ROOT/docs/specs/refactor_agent_system.md" ]; then
        log_success "ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸ç¢ºèª"
        export CLAUDE_SYSTEM_SPEC="$PROJECT_ROOT/docs/specs/refactor_agent_system.md"
    fi
}

# ãƒ„ãƒ¼ãƒ«å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
check_required_tools() {
    log_info "å¿…è¦ãƒ„ãƒ¼ãƒ«ã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯"
    
    local tools=("git" "find" "grep" "awk" "sed")
    local missing_tools=()
    
    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -eq 0 ]; then
        log_success "ã™ã¹ã¦ã®å¿…è¦ãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨å¯èƒ½"
    else
        log_info "ä¸è¶³ãƒ„ãƒ¼ãƒ«: ${missing_tools[*]}"
    fi
    
    # è¿½åŠ ãƒ„ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯
    if command -v jq &> /dev/null; then
        export CLAUDE_HAS_JQ="true"
        log_success "jqåˆ©ç”¨å¯èƒ½"
    fi
    
    if command -v bc &> /dev/null; then
        export CLAUDE_HAS_BC="true"
        log_success "bcåˆ©ç”¨å¯èƒ½"
    fi
}

# Gitãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹ç¢ºèª
check_git_status() {
    log_info "Gitãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹ç¢ºèª"
    
    if ! git rev-parse --git-dir &> /dev/null; then
        log_info "Gitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“"
        return
    fi
    
    # ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
    local branch=$(git branch --show-current 2>/dev/null || echo "ä¸æ˜")
    log_info "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $branch"
    export CLAUDE_CURRENT_BRANCH="$branch"
    
    # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çŠ¶æ…‹
    if git diff --quiet && git diff --cached --quiet; then
        log_success "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã‚¯ãƒªãƒ¼ãƒ³"
        export CLAUDE_REPO_CLEAN="true"
    else
        log_info "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã‚ã‚Š"
        export CLAUDE_REPO_CLEAN="false"
    fi
}

# ä½œæ¥­å±¥æ­´ã®ç¢ºèª
check_work_history() {
    log_info "ä½œæ¥­å±¥æ­´ç¢ºèª"
    
    # æœ€å¾Œã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚°ç¢ºèª
    local latest_log=$(ls -t "$PROJECT_ROOT/docs/logs"/refactor_log_*.md 2>/dev/null | head -1)
    if [ -f "$latest_log" ]; then
        log_success "æœ€æ–°ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚°: $(basename "$latest_log")"
        export CLAUDE_LATEST_REFACTOR_LOG="$latest_log"
    fi
    
    # é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª
    if [ -f "$PROJECT_ROOT/docs/logs/progress_dashboard.md" ]; then
        log_success "é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç¢ºèª"
        export CLAUDE_PROGRESS_DASHBOARD="$PROJECT_ROOT/docs/logs/progress_dashboard.md"
    fi
}

# åˆæœŸåŒ–å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_initialization_complete() {
    local agent_role="$1"
    
    cat << EOF

ğŸš€ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†

## è¨­å®šæƒ…å ±
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«: ${agent_role:-"æ±ç”¨"}
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: $PROJECT_ROOT
- ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PROJECT_ROOT/docs/logs
- ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${CLAUDE_CURRENT_BRANCH:-"ä¸æ˜"}

## åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: ./scripts/run_and_verify_tests.sh
- Worktreeç®¡ç†: ./scripts/create_worktree.sh
- ç¶™ç¶šç›£è¦–: ./scripts/continuous_test_monitoring.sh

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
æŒ‡ç¤ºæ›¸ã«å¾“ã£ã¦ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
EOF

    log_success "åˆæœŸåŒ–å®Œäº†"
}

# ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–å‡¦ç†
main() {
    cd "$PROJECT_ROOT"
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ¤œå‡º
    local agent_role=$(detect_agent_role)
    
    # å„ç¨®è¨­å®šå®Ÿè¡Œ
    load_project_config
    setup_agent_environment "$agent_role"
    check_required_tools
    check_git_status
    check_work_history
    
    # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    show_initialization_complete "$agent_role"
}

# åˆæœŸåŒ–å®Ÿè¡Œ
main "$@"